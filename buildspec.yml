version: 0.2

env:
  variables:
    AWS_REGION: "ap-south-1"                    #Region
    AWS_ACCOUNT_ID: "654654304213"              #AWS account ID
    CODEARTIFACT_DOMAIN: "microservice"         #CodeArtifact domain
    CODEARTIFACT_DOMAIN_OWNER: "654654304213"   #usually same as account ID
    CODEARTIFACT_REPO: "maven-repo"

phases:
  install:
    runtime-versions:
      java: corretto11
    commands:
      - echo "Install phase"
      - aws --version
      - docker --version

  pre_build:
    commands:
      - echo "Authenticate with CodeArtifact"
      - |
        export CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
          --domain $CODEARTIFACT_DOMAIN \
          --domain-owner $CODEARTIFACT_DOMAIN_OWNER \
          --query authorizationToken \
          --output text \
          --region $AWS_REGION)

      - |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml <<EOF
        <settings>
          <servers>
            <server>
              <id>codeartifact</id>
              <username>aws</username>
              <password>$CODEARTIFACT_AUTH_TOKEN</password>
            </server>
          </servers>
        </settings>
        EOF

      - echo "Authenticate Docker with ECR"
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

  build:
    commands:
      - echo "Installing parent POM"
      - mvn -B -f pom.xml clean install -DskipTests
      - echo "Starting build for all microservices"

      # Define microservices list
      - |
        SERVICES=("catalog" "customer" "order" "apache")

        # Loop through each microservice
        for SERVICE_NAME in "${SERVICES[@]}"; do
          echo "==============================";
          echo "Building service: $SERVICE_NAME";
          echo "==============================";
          cd $SERVICE_NAME;

          if [ "$SERVICE_NAME" != "apache" ]; then
           echo "Building and packaging with Maven";
           mvn -B -DskipTests package;
           mvn -B -DskipTests deploy;
          fi

          echo "Building Docker image";
          IMAGE_TAG=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${SERVICE_NAME}:build-${CODEBUILD_BUILD_NUMBER};
          docker build -t $IMAGE_TAG .;
          docker push $IMAGE_TAG;

          printf '[{"name":"%s","imageUri":"%s"}]' "$SERVICE_NAME" "$IMAGE_TAG" > ../${SERVICE_NAME}-imagedefinitions.json;
          cd ..;
        done

  post_build:
    commands:
      - echo "All builds completed successfully"
      - ls -l

artifacts:
  files:
    - catalog-imagedefinitions.json
    - customer-imagedefinitions.json
    - order-imagedefinitions.json


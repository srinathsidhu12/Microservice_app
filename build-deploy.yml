version: 0.2

env:
  variables:
    AWS_REGION: "ap-south-1"                        # change if needed
    CLUSTER_NAME: "microservice-eks-cluster"       # change if needed
    AWS_ACCOUNT_ID: "654654304213"                              # optional: leave empty to auto-detect

phases:
  install:
    commands:
      - echo "=== INSTALL PHASE ==="
      - echo "Ensure awscli present (CodeBuild standard images include it)"
      - echo "Installing kubectl (stable release)..."
      - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      - chmod +x kubectl
      - mv kubectl /usr/local/bin/kubectl
      - echo "kubectl client version:"
      - kubectl version --client || true

  pre_build:
    commands:
      - echo "=== PRE_BUILD PHASE ==="
      - echo "Resolve AWS account id if not provided..."
      - if [ -z "$AWS_ACCOUNT_ID" ]; then export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text); fi
      - echo "Using AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID and AWS_REGION=$AWS_REGION"
      - echo "Configuring kubeconfig for EKS cluster $CLUSTER_NAME..."
      - aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
      - echo "kubectl cluster info (quick check):"
      - kubectl cluster-info

      - echo "Fetching latest tags from ECR for each service..."
      - REPO_BASE="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
      - echo "Repository prefix: $REPO_BASE"

      - echo "Get latest catalog tag..."
      - LATEST_CATALOG_TAG=$(aws ecr describe-images --repository-name catalog --region $AWS_REGION --query "sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]" --output text)
      - echo "Get latest customer tag..."
      - LATEST_CUSTOMER_TAG=$(aws ecr describe-images --repository-name customer --region $AWS_REGION --query "sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]" --output text)
      - echo "Get latest order tag..."
      - LATEST_ORDER_TAG=$(aws ecr describe-images --repository-name order --region $AWS_REGION --query "sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]" --output text)
      - echo "Get latest apache tag..."
      - LATEST_APACHE_TAG=$(aws ecr describe-images --repository-name apache --region $AWS_REGION --query "sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]" --output text)

      - echo "Latest tags found:"
      - echo " catalog: $LATEST_CATALOG_TAG"
      - echo " customer: $LATEST_CUSTOMER_TAG"
      - echo " order:   $LATEST_ORDER_TAG"
      - echo " apache:  $LATEST_APACHE_TAG"

      # fail fast if any tag missing
      - if [ "$LATEST_CATALOG_TAG" = "None" ] || [ -z "$LATEST_CATALOG_TAG" ] || [ "$LATEST_CATALOG_TAG" = "null" ]; then echo "ERROR: catalog latest tag not found in ECR"; exit 1; fi
      - if [ "$LATEST_CUSTOMER_TAG" = "None" ] || [ -z "$LATEST_CUSTOMER_TAG" ] || [ "$LATEST_CUSTOMER_TAG" = "null" ]; then echo "ERROR: customer latest tag not found in ECR"; exit 1; fi
      - if [ "$LATEST_ORDER_TAG" = "None" ] || [ -z "$LATEST_ORDER_TAG" ] || [ "$LATEST_ORDER_TAG" = "null" ]; then echo "ERROR: order latest tag not found in ECR"; exit 1; fi
      - if [ "$LATEST_APACHE_TAG" = "None" ] || [ -z "$LATEST_APACHE_TAG" ] || [ "$LATEST_APACHE_TAG" = "null" ]; then echo "ERROR: apache latest tag not found in ECR"; exit 1; fi

  build:
    commands:
      - echo "=== BUILD / DEPLOY PHASE ==="

      - echo "Prepare full image URIs (catalog)..."
      - CATALOG_IMAGE="${REPO_BASE}/catalog:${LATEST_CATALOG_TAG}"
      - echo "Replacing IMAGE_URI in k8s/catalog-deployment.yaml -> $CATALOG_IMAGE"
      - sed -i "s|IMAGE_URI|${CATALOG_IMAGE}|g" k8s/catalog-deployment.yaml
      - kubectl apply -f k8s/catalog-deployment.yaml
      - kubectl apply -f k8s/catalog-service.yaml

      - echo "Prepare full image URIs (customer)..."
      - CUSTOMER_IMAGE="${REPO_BASE}/customer:${LATEST_CUSTOMER_TAG}"
      - echo "Replacing IMAGE_URI in k8s/customer-deployment.yaml -> $CUSTOMER_IMAGE"
      - sed -i "s|IMAGE_URI|${CUSTOMER_IMAGE}|g" k8s/customer-deployment.yaml
      - kubectl apply -f k8s/customer-deployment.yaml
      - kubectl apply -f k8s/customer-service.yaml

      - echo "Prepare full image URIs (order)..."
      - ORDER_IMAGE="${REPO_BASE}/order:${LATEST_ORDER_TAG}"
      - echo "Replacing IMAGE_URI in k8s/order-deployment.yaml -> $ORDER_IMAGE"
      - sed -i "s|IMAGE_URI|${ORDER_IMAGE}|g" k8s/order-deployment.yaml
      - kubectl apply -f k8s/order-deployment.yaml
      - kubectl apply -f k8s/order-service.yaml

      - echo "Prepare full image URIs (apache)..."
      - APACHE_IMAGE="${REPO_BASE}/apache:${LATEST_APACHE_TAG}"
      - echo "Replacing IMAGE_URI in k8s/apache-deployment.yaml -> $APACHE_IMAGE"
      - sed -i "s|IMAGE_URI|${APACHE_IMAGE}|g" k8s/apache-deployment.yaml
      - kubectl apply -f k8s/apache-deployment.yaml
      - kubectl apply -f k8s/apache-service.yaml

  post_build:
    commands:
      - echo "=== POST_BUILD: verify deployments & rollout status ==="
      - kubectl get deployments -o wide
      - kubectl get pods -o wide
      - kubectl rollout status deployment/catalog-deployment --timeout=120s || true
      - kubectl rollout status deployment/customer-deployment --timeout=120s || true
      - kubectl rollout status deployment/order-deployment --timeout=120s || true
      - kubectl rollout status deployment/apache --timeout=120s || true
      - echo "Deployment job finished."

artifacts:
  files:
    - "**/*"


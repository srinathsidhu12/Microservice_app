version: 0.2

env:
  variables:
    AWS_REGION: "ap-south-1"
    CLUSTER_NAME: "microservice-eks-cluster"
    AWS_ACCOUNT_ID: "654654304213"
    SERVICES: "catalog customer order apache"

phases:
  install:
    commands:
      - echo "Installing kubectl"
      - curl -o kubectl -L "https://amazon-eks.s3.us-west-2.amazonaws.com/1.30.0/2024-05-31/bin/linux/amd64/kubectl"
      - chmod +x kubectl
      - mv kubectl /usr/local/bin/kubectl
      - echo "Verifying kubectl installation..."
      - kubectl version --client

  pre_build:
    commands:
      - echo "=== Configuring access to EKS ==="
      - aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
      - echo "Connected to EKS cluster: $CLUSTER_NAME"

  build:
    commands:
      - echo "=== Deploying services to EKS ==="
      - |
        for SERVICE_NAME in $SERVICES; do
          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${SERVICE_NAME}:build-${CODEBUILD_BUILD_NUMBER}"
          echo "Updating image for $SERVICE_NAME -> $IMAGE_URI"
          sed -i "s|IMAGE_URI|$IMAGE_URI|g" k8s/${SERVICE_NAME}-deployment.yaml
          echo "Applying Kubernetes manifests for $SERVICE_NAME"
          kubectl apply -f k8s/${SERVICE_NAME}-deployment.yaml
          kubectl apply -f k8s/${SERVICE_NAME}-service.yaml
        done

  post_build:
    commands:
      - echo "=== Verifying deployments ==="
      - kubectl get pods -o wide
      - kubectl get svc -o wide

artifacts:
  files:
    - "**/*"


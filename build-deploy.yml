version: 0.2

env:
  variables:
    AWS_REGION: "ap-south-1"
    CLUSTER_NAME: "microservice-eks-cluster"
    AWS_ACCOUNT_ID: "654654304213"
    TAG: "build-${CODEBUILD_BUILD_NUMBER}"

phases:
  install:
    commands:
      - echo "Installing kubectl..."
      - curl -o kubectl -LO "https://s3.us-west-2.amazonaws.com/amazon-eks/1.29.0/2024-06-13/bin/linux/amd64/kubectl"
      - chmod +x kubectl
      - mv kubectl /usr/local/bin/kubectl
      - kubectl version --client


  pre_build:
    commands:
      - echo "Configuring kubectl with EKS cluster..."
      - aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
      - kubectl cluster-info

  build:
    commands:
      - echo "Deploying catalog service..."
      - CATALOG_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/catalog:$TAG"
      - sed -i "s|IMAGE_URI|$CATALOG_IMAGE|g" k8s/catalog-deployment.yaml
      - kubectl apply -f k8s/catalog-deployment.yaml
      - kubectl apply -f k8s/catalog-service.yaml

      - echo "Deploying customer service..."
      - CUSTOMER_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/customer:$TAG"
      - sed -i "s|IMAGE_URI|$CUSTOMER_IMAGE|g" k8s/customer-deployment.yaml
      - kubectl apply -f k8s/customer-deployment.yaml
      - kubectl apply -f k8s/customer-service.yaml

      - echo "Deploying order service..."
      - ORDER_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/order:$TAG"
      - sed -i "s|IMAGE_URI|$ORDER_IMAGE|g" k8s/order-deployment.yaml
      - kubectl apply -f k8s/order-deployment.yaml
      - kubectl apply -f k8s/order-service.yaml

      - echo "Deploying apache service..."
      - APACHE_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/apache:$TAG"
      - sed -i "s|IMAGE_URI|$APACHE_IMAGE|g" k8s/apache-deployment.yaml
      - kubectl apply -f k8s/apache-deployment.yaml
      - kubectl apply -f k8s/apache-service.yaml

  post_build:
    commands:
      - echo "Verifying deployments..."
      - kubectl get pods -o wide
      - kubectl get svc -o wide
      - echo "Deployment completed successfully!"

artifacts:
  files:
    - "**/*"

